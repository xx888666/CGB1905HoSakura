<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bootstrap Material Admin</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="login/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,700">
    <link rel="stylesheet" href="login/css/style.default.css" id="theme-stylesheet">
</head>
<body>
<div class="page login-page">
    <div class="container d-flex align-items-center">
        <div class="form-holder has-shadow">
            <div class="row">
                <!-- Logo & Information Panel-->
                <div class="col-lg-6">
                    <div class="info d-flex align-items-center">
                        <div class="content">
                            <div class="logo">
                                <h1>欢迎注册</h1>
                            </div>
                            <p>注册登录界面模板</p>
                        </div>
                    </div>
                </div>
                <!-- Form Panel    -->
                <div class="col-lg-6 bg-white">
                    <div class="form d-flex align-items-center">
                        <div class="content">
                            <form action="/user/register" method="post">
                                <div class="form-group">
                                    <input id="register-username" class="input-material" type="text"
                                           name="registerUsername" placeholder="请输入用户名/姓名">
                                    <div class="invalid-feedback" id="usernameCheck">
                                        用户名必须在2~10位之间
                                    </div>

                                    <!-- 为验证用户名是否存在设的div, 当用户名存在时, 这里显示用户名已存在 -->
                                    <div class="" id="usernameExist">

                                    </div>

                                </div>

                                <div class="form-group">
                                    <input id="register-password" class="input-material" type="password"
                                           name="registerPassword" placeholder="请输入密码">
                                    <div class="invalid-feedback">
                                        密码必须在6~18位之间
                                    </div>
                                </div>
                                <div class="form-group">
                                    <input id="register-passwords" class="input-material" type="password"
                                           name="registerPasswords" placeholder="确认密码">
                                    <div class="invalid-feedback">
                                        两次密码必须相同 且在6~18位之间
                                    </div>
                                </div>

                                <div class="form-group">
                                    <input id="register-name" class="input-material" type="text"
                                           name="registerName" placeholder="真实姓名">

                                </div>

                                <div class="form-group">
                                    <input id="register-IdNumber" class="input-material" type="text"
                                           name="registerName" placeholder="请输入身份证号">

                                    <div class="" id="checkIdNumber">
                                    </div>

                                </div>


                                <!--让用户输入电话号码-->
                                <div class="form-group">
                                    <input id="register-phone" class="input-material" type="text"
                                           name="registerPhone" placeholder="请输入手机号码">

                                    <div class="" id="checkPhone">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <!-- 注册按钮, 将上面表单提交到指定后台url -->
                                    <input id="regbtn" class="btn btn-primary" type="button" name="" value="注册" onclick="">
                                    <input id="regbtn1" class="btn btn-primary" type="button" name="" value="注册" onclick="register()">
                            </form>
                        </div>
                        <small>已有账号?</small>
                        <a href="login.html" class="signup">&nbsp;登录</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- JavaScript files-->
<script src="login/js/jquery.min.js"></script>
<script src="login/js/bootstrap.min.js"></script>
<script>
    $(function () {
        /*错误class  form-control is-invalid
        正确class  form-control is-valid*/
        var flagName = false;
        var flagPas = false;
        var flagPass = false;
        /*验证用户名*/
        var name, passWord, passWords;
        $("#register-username").change(function () {
            name = $("#register-username").val();
            if (name.length < 2 || name.length > 10) {
                $("#register-username").removeClass("form-control is-valid")
                $("#register-username").addClass("form-control is-invalid");
                flagName = false;
            } else {
                $("#register-username").removeClass("form-control is-invalid")
                $("#register-username").addClass("form-control is-valid");
                flagName = true;
            }
        })
        /*验证密码*/
        $("#register-password").change(function () {
            passWord = $("#register-password").val();
            if (passWord.length < 6 || passWord.length > 18) {
                $("#register-password").removeClass("form-control is-valid")
                $("#register-password").addClass("form-control is-invalid");
                flagPas = false;
            } else {
                $("#register-password").removeClass("form-control is-invalid")
                $("#register-password").addClass("form-control is-valid");
                flagPas = true;
            }
        })
        /*验证确认密码*/
        $("#register-passwords").change(function () {
            passWords = $("#register-passwords").val();
            if ((passWord != passWords) || (passWords.length < 6 || passWords.length > 18)) {
                $("#register-passwords").removeClass("form-control is-valid")
                $("#register-passwords").addClass("form-control is-invalid");
                flagPass = false;
            } else {
                $("#register-passwords").removeClass("form-control is-invalid")
                $("#register-passwords").addClass("form-control is-valid");
                flagPass = true;
            }
        })


        $("#regbtn").click(function () {
            //当这些验证不成功时, 按注册按钮就会提示注册失败
            if (!flagName) {
                $("#register-username").addClass("form-control is-invalid");
                //当用户名重复时, 注册按钮应该被禁止
                $("#regbtn").attr("onclick", "").click(function () {
                    alert("注册失败");
                    //刷新网页, 让用户重新输入
                    location.reload();
                })
            }
            if (!flagPas) {
                $("#register-password").addClass("form-control is-invalid");
                //当用户名重复时, 注册按钮应该被禁止
                $("#regbtn").attr("onclick", "").click(function () {
                    alert("注册失败");
                    //刷新网页, 让用户重新输入
                    location.reload();
                })
            }
            if (!flagPass) {
                $("#register-passwords").addClass("form-control is-invalid");
                //当用户名重复时, 注册按钮应该被禁止
                $("#regbtn").attr("onclick", "").click(function () {
                    alert("注册失败");
                    //刷新网页, 让用户重新输入
                    location.reload();
                })
            }

        })


        //当用户输入时判断用户名是否存在
        // 当焦点移出用户名输入框时
        $("#register-username").blur(function () {
            //var userName = $.trim($(this));
            var userName = $("#register-username").val();
            console.log(userName);
            // 判断是否为空及空格
            if (userName == "") {
                return;
            }

            // 校验用户名是否存在,该URL可以返回该用户名存在的数量
            var url = "user/check/" + userName;
            // 清空用户名表单提示信息内容
            var usernameExist = $("#usernameExist");
            usernameExist.html("");
            // 使用ajax去后台判断该用户名在数据库中是否存在
            $.ajax({
                url: url,
                type: 'GET',

                success: function (data) {
                    console.log(data);
                    // 数据库中存在该用户名
                    if (data.state == 2) {
                        // 将错误信息添加至相应位置
                        usernameExist.html(data.message);

                        //改变颜色框, 显示错误的颜色框
                        $("#register-username").removeClass("form-control is-valid")
                        $("#register-username").addClass("form-control is-invalid");
                        $("#usernameCheck").html("");
                        flagName = false;

                        //当用户名重复时, 注册按钮应该被禁止
                        $("#regbtn").attr("onclick", "").click(function () {
                            alert("注册失败");
                            //刷新网页, 让用户重新输入
                            location.reload();
                        })

                    } else {
                        //改变颜色框, 显示正确的颜色框
                        $("#register-passwords").removeClass("form-control is-invalid")
                        $("#register-passwords").addClass("form-control is-valid");
                        flagPass = true;
                        usernameExist.html("该用户名可以使用");
                        //将注册按钮改为submit状态
                        $("#regbtn").attr("onclick", "register()");

                    }
                },
                error: function () {
                    usernameExist.html("校验用户名出现错误");
                }
            });
        });


        //判断用户输入的手机号是否符合格式
        $("#register-phone").change(function () {
            //获取用户输入的手机号码
            var phone = $("#register-phone").val();
            //用正则表达式判断
            if(!(/^1[3456789]\d{9}$/.test(phone))){
                //因为发生错误, 将输入框改为红色
                $("#register-phone").removeClass("form-control is-valid");
                $("#register-phone").addClass("form-control is-invalid");

                $("#checkPhone").html("手机号格式错误");
                //当手机号格式错误时, 注册按钮应该被禁止
                $("#regbtn").attr("onclick", "").click(function () {
                    alert("注册失败");
                    //刷新网页, 让用户重新输入
                    location.reload();
                })
            } else {//如果输入正确, 就恢复正确的注册按钮

                //输入正确时, 将输入框改为绿色
                $("#register-phone").removeClass("form-control is-invalid")
                $("#register-phone").addClass("form-control is-valid");

                //将注册按钮改为submit状态
                $("#regbtn").attr("onclick", "register()");
                //将错误信息删除
                $("#checkPhone").html("");
            }
        });


        //判断身份证号是否符合格式
        $("#register-IdNumber").blur(function () {

            var idNumber = $("#register-IdNumber").val();
            // 正则表达式：
            var idcardReg = /^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$|^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/;

            //当不匹配时
            if(!(idcardReg.test(idNumber))) {
                $("#checkIdNumber").html("身份证号格式错误");

                //因为发生错误, 将输入框改为红色
                $("#register-IdNumber").removeClass("form-control is-valid")
                $("#register-IdNumber").addClass("form-control is-invalid");

                //当身份证格式错误时, 注册按钮应该被禁止
                $("#regbtn").attr("onclick", "").click(function () {
                    alert("注册失败");
                    //刷新网页, 让用户重新输入
                    location.reload();
                })
            } else {//如果输入正确, 就恢复正确的注册按钮

                //输入正确时, 将输入框改为绿色
                $("#register-IdNumber").removeClass("form-control is-invalid")
                $("#register-IdNumber").addClass("form-control is-valid");

                //将注册按钮改为submit状态
                $("#regbtn").attr("onclick", "register()");
                //将错误提示删除
                $("#checkIdNumber").html("");
            }

        });



    })
    //注册按钮的点击事件, 运行这个方法实现用户注册入库
    function register() {
        //将注册参数封装到对象
        var user = {
            username:$("#register-username").val(),
            password:$("#register-passwords").val(),
            name:$("#register-name").val(),
            idNumber:$("#register-IdNumber").val(),
            phone:$("#register-phone").val()
        }
        console.log(user);

        // 使用ajax去后台实现注册
        $.ajax({
            url: "user/register",
            type: 'post',
            data: {
                'username':$("#register-username").val(),
                'password':$("#register-passwords").val(),
                'name':$("#register-name").val(),
                'idNumber':$("#register-IdNumber").val(),
                'phone':$("#register-phone").val()
            },
            dataType:"json",

            success: function (data) {
                console.log(data);
                //当状态码为1, 说明注册成功
                if (data.state == 1) {
                    alert(data.message);
                    //将注册按钮改为submit状态
                    //$("#regbtn").attr("onclick", "register()");
                    //跳转至登录页面
                    window.location.href="login";

                } else {
                    //如果状态码不为1, 说明出现了异常, 弹框提示, 并不做其他事情
                    alert(data.message);

                }
            }
        });

    }
</script>
</body>
</html>